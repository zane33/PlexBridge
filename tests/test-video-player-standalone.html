<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Player Test</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #000;
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .test-button:hover {
            background: #1565c0;
        }
        .video-container {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
        }
        video {
            width: 100%;
            max-width: 600px;
            height: auto;
        }
        .console-output {
            background: #222;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196f3; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        // Test Video Player Component (based on our fixes)
        const TestVideoPlayer = ({ streamUrl, streamName, streamType }) => {
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [hlsInstance, setHlsInstance] = useState(null);
            const [videoReady, setVideoReady] = useState(false);
            const [logs, setLogs] = useState([]);
            
            const videoRef = useRef(null);
            
            const addLog = (message, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                setLogs(prev => [...prev, { message, type, timestamp }].slice(-50));
                console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            };

            // Fixed getStreamUrl without problematic dependencies
            const getStreamUrl = useCallback(() => {
                addLog(`Using direct stream URL: ${streamUrl}`, 'info');
                return streamUrl;
            }, [streamUrl]);

            // Fixed initializePlayer without infinite loop dependencies
            const initializePlayer = useCallback(async () => {
                addLog('initializePlayer called', 'info');
                
                if (!streamUrl) {
                    addLog('No stream URL provided', 'warning');
                    return;
                }
                
                if (!videoRef.current) {
                    addLog('Video element not ready', 'warning');
                    return;
                }

                setLoading(true);
                setError(null);
                setVideoReady(false);

                try {
                    const currentUrl = getStreamUrl();
                    
                    addLog(`Initializing player for: ${currentUrl}`, 'info');
                    addLog(`Stream type: ${streamType}`, 'info');
                    
                    // Clean up previous HLS instance
                    if (hlsInstance) {
                        addLog('Cleaning up previous HLS instance', 'info');
                        hlsInstance.destroy();
                        setHlsInstance(null);
                    }

                    // Handle HLS streams
                    if (currentUrl.includes('.m3u8') || streamType === 'hls') {
                        if (Hls.isSupported()) {
                            addLog('Using HLS.js for playback', 'info');
                            const hls = new Hls({
                                enableWorker: true,
                                lowLatencyMode: true,
                                backBufferLength: 90,
                                maxBufferLength: 30,
                            });
                            
                            setHlsInstance(hls);
                            
                            hls.on(Hls.Events.MANIFEST_LOADED, () => {
                                setVideoReady(true);
                                addLog('HLS stream loaded successfully!', 'success');
                            });
                            
                            hls.on(Hls.Events.ERROR, (event, data) => {
                                addLog(`HLS Error: ${data.details || data.type}`, 'error');
                                if (data.fatal) {
                                    setError({ 
                                        message: `HLS Error: ${data.details || data.type}`, 
                                        canRecover: true 
                                    });
                                }
                            });
                            
                            try {
                                hls.loadSource(currentUrl);
                                hls.attachMedia(videoRef.current);
                                addLog('HLS source loaded and attached', 'success');
                            } catch (hlsError) {
                                addLog(`HLS attachment error: ${hlsError.message}`, 'error');
                                hls.destroy();
                                setHlsInstance(null);
                                throw hlsError;
                            }
                            
                        } else if (videoRef.current.canPlayType('application/vnd.apple.mpegurl')) {
                            // Safari native HLS support
                            addLog('Using Safari native HLS support', 'info');
                            videoRef.current.src = currentUrl;
                            videoRef.current.load();
                            setVideoReady(true);
                        } else {
                            setError({ 
                                message: 'HLS not supported in this browser', 
                                canRecover: false 
                            });
                        }
                    } else {
                        // Direct video for non-HLS streams
                        addLog('Using native player for direct stream', 'info');
                        
                        // Clear any existing source before setting new one
                        videoRef.current.src = '';
                        videoRef.current.load();
                        
                        // Set new source and load
                        videoRef.current.src = currentUrl;
                        videoRef.current.load();
                        
                        addLog('Direct stream source set', 'info');
                    }

                } catch (error) {
                    addLog(`Player initialization error: ${error.message}`, 'error');
                    setError({ 
                        message: error.message || 'Failed to initialize player', 
                        canRecover: true 
                    });
                } finally {
                    setLoading(false);
                }
            }, [streamUrl, streamType]);

            // Single consolidated effect (our fix)
            useEffect(() => {
                let isMounted = true;
                let timeoutId = null;

                const initPlayer = async () => {
                    if (!videoRef.current) {
                        if (timeoutId) clearTimeout(timeoutId);
                        timeoutId = setTimeout(() => {
                            if (isMounted && videoRef.current && streamUrl) {
                                initializePlayer();
                            }
                        }, 100);
                        return;
                    }
                    
                    if (isMounted && streamUrl) {
                        await initializePlayer();
                    }
                };

                if (streamUrl) {
                    initPlayer();
                }

                return () => {
                    isMounted = false;
                    if (timeoutId) {
                        clearTimeout(timeoutId);
                    }
                    // Cleanup HLS instance on unmount
                    if (hlsInstance) {
                        addLog('Cleaning up HLS instance on unmount', 'info');
                        hlsInstance.destroy();
                        setHlsInstance(null);
                    }
                };
            }, [streamUrl, streamType]);

            return (
                <div className="video-container">
                    <h3>{streamName}</h3>
                    
                    {loading && (
                        <div style={{ textAlign: 'center', padding: '20px' }}>
                            <p>Loading stream...</p>
                        </div>
                    )}

                    {error && (
                        <div style={{ background: '#d32f2f', padding: '10px', margin: '10px 0', borderRadius: '4px' }}>
                            <strong>Error:</strong> {error.message}
                        </div>
                    )}

                    <video
                        ref={videoRef}
                        controls
                        autoPlay={false}
                        muted
                        crossOrigin="anonymous"
                        playsInline
                        style={{
                            width: '100%',
                            height: 'auto',
                            display: loading ? 'none' : 'block'
                        }}
                        onError={(e) => {
                            const target = e.target;
                            let errorMessage = 'Video playback error';
                            
                            if (target && target.error) {
                                switch (target.error.code) {
                                    case target.error.MEDIA_ERR_NETWORK:
                                        errorMessage = 'Network error - check stream URL';
                                        break;
                                    case target.error.MEDIA_ERR_DECODE:
                                        errorMessage = 'Video decode error - unsupported format';
                                        break;
                                    case target.error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                                        errorMessage = 'Stream format not supported';
                                        break;
                                    default:
                                        errorMessage = target.error.message || `Unknown error (code: ${target.error.code})`;
                                }
                            }
                            
                            addLog(`Video error: ${errorMessage}`, 'error');
                            setError({ message: errorMessage, canRecover: true });
                        }}
                        onLoadStart={() => addLog('Video load started', 'info')}
                        onCanPlay={() => {
                            addLog('Video can play - setting ready state', 'success');
                            setVideoReady(true);
                            setLoading(false);
                            const video = videoRef.current;
                            if (video) {
                                addLog(`Video details: ${video.videoWidth}x${video.videoHeight}, duration: ${video.duration}s`, 'info');
                            }
                        }}
                        onLoadedMetadata={() => {
                            addLog('Video metadata loaded', 'info');
                            const video = videoRef.current;
                            if (video) {
                                const hasVideoTrack = video.videoWidth > 0 && video.videoHeight > 0;
                                const hasAudioTrack = video.mozHasAudio || Boolean(video.webkitAudioDecodedByteCount);
                                
                                addLog(`Metadata: ${video.videoWidth}x${video.videoHeight}, hasVideo: ${hasVideoTrack}, hasAudio: ${hasAudioTrack}`, 'info');
                                
                                if (!hasVideoTrack && hasAudioTrack) {
                                    addLog('Only audio track detected - video may not display', 'warning');
                                }
                            }
                        }}
                    />

                    <div className="console-output">
                        <h4>Console Output:</h4>
                        {logs.map((log, index) => (
                            <div key={index} className={log.type}>
                                [{log.timestamp}] {log.message}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Main Test App
        const TestApp = () => {
            const [activeStream, setActiveStream] = useState(null);

            const testStreams = [
                {
                    name: 'HLS Test Stream (Apple)',
                    url: 'https://devstreaming-cdn.apple.com/videos/streaming/examples/bipbop_4x3/bipbop_4x3_variant.m3u8',
                    type: 'hls'
                },
                {
                    name: 'Big Buck Bunny MP4',
                    url: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                    type: 'mp4'
                },
                {
                    name: 'Sintel MP4',
                    url: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/Sintel.mp4', 
                    type: 'mp4'
                }
            ];

            return (
                <div className="container">
                    <h1>Video Player Loop Fix Test</h1>
                    <p>This test verifies that the video player no longer has infinite initialization loops.</p>
                    
                    <div>
                        <h2>Test Streams:</h2>
                        {testStreams.map((stream, index) => (
                            <button
                                key={index}
                                className="test-button"
                                onClick={() => setActiveStream(stream)}
                            >
                                Test {stream.name}
                            </button>
                        ))}
                        <button
                            className="test-button"
                            onClick={() => setActiveStream(null)}
                            style={{ background: '#666' }}
                        >
                            Clear
                        </button>
                    </div>

                    {activeStream && (
                        <TestVideoPlayer
                            key={activeStream.url}
                            streamUrl={activeStream.url}
                            streamName={activeStream.name}
                            streamType={activeStream.type}
                        />
                    )}

                    {!activeStream && (
                        <div className="video-container">
                            <p>Click a test button above to verify that:</p>
                            <ul>
                                <li>✅ No infinite console logs appear</li>
                                <li>✅ Video player initializes only once</li>
                                <li>✅ Video content displays properly</li>
                                <li>✅ HLS streams work with proper codec support</li>
                                <li>✅ Error handling is graceful</li>
                            </ul>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<TestApp />, document.getElementById('root'));
    </script>
</body>
</html>